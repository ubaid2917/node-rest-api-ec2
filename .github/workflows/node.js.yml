name: Node.js CI/CD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"

      - name: Deploy
        env:
          APP_NAME: BackendApi
          LAST_OK_FILE: /home/ubuntu/actions-runner/last_ok_sha.txt
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
          NEW_SHA: ${{ github.sha }}
        run: |
          set -e

          echo "$PROD_ENV_FILE" > .env
          npm ci
          pm2 restart "$APP_NAME"

          # optional health check (recommended)
          # curl -fsS http://127.0.0.1:5000/api/products > /dev/null

          echo "$NEW_SHA" > "$LAST_OK_FILE"

      - name: Rollback (if deploy failed)
        if: failure()
        env:
          APP_NAME: BackendApi
          LAST_OK_FILE: /home/ubuntu/actions-runner/last_ok_sha.txt
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          set -e

          if [ -f "$LAST_OK_FILE" ]; then
            OK_SHA="$(cat "$LAST_OK_FILE")"
            echo "Rolling back to last successful SHA: $OK_SHA"
          else
            OK_SHA="$(git rev-parse HEAD~1)"
            echo "No last_ok_sha.txt. Rolling back to previous commit: $OK_SHA"
          fi

          git checkout "$OK_SHA"

          echo "$PROD_ENV_FILE" > .env
          npm ci
          pm2 restart "$APP_NAME"