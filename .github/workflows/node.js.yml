name: Node.js CI/CD

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # IMPORTANT for rollback checkout

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"

      - name: Deploy
        env:
          APP_NAME: BackendApi
          APP_DIR: /home/ubuntu/apps/BackendApi
          LAST_OK_FILE: /home/ubuntu/apps/BackendApi/last_ok_sha.txt
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
          NEW_SHA: ${{ github.sha }}
        run: |
          set -e

          mkdir -p "$APP_DIR"

          rsync -a --delete --exclude ".git" --exclude "node_modules" ./ "$APP_DIR/"
          echo "$PROD_ENV_FILE" > "$APP_DIR/.env"

          cd "$APP_DIR"
          npm ci

          pm2 restart "$APP_NAME"

          # ✅ optional health check (recommended)
          # curl -fsS http://127.0.0.1:5000/api/products > /dev/null

          # ✅ save last good commit id
          echo "$NEW_SHA" > "$LAST_OK_FILE"

      - name: Rollback (if deploy failed)
        if: failure()
        env:
          APP_NAME: BackendApi
          APP_DIR: /home/ubuntu/apps/BackendApi
          LAST_OK_FILE: /home/ubuntu/apps/BackendApi/last_ok_sha.txt
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          set -e

          if [ -f "$LAST_OK_FILE" ]; then
            OK_SHA="$(cat "$LAST_OK_FILE")"
            echo "Rolling back to last successful SHA: $OK_SHA"
          else
            OK_SHA="$(git rev-parse HEAD~1)"
            echo "No last_ok_sha.txt. Rolling back to previous commit: $OK_SHA"
          fi

          git checkout "$OK_SHA"

          rsync -a --delete --exclude ".git" --exclude "node_modules" ./ "$APP_DIR/"
          echo "$PROD_ENV_FILE" > "$APP_DIR/.env"

          cd "$APP_DIR"
          npm ci
          pm2 restart "$APP_NAME"