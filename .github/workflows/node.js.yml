- name: Deploy (releases + symlink) + PM2
  shell: bash
  run: |
    set -euo pipefail

    APP_DIR="/var/www/node-rest-api"
    RELEASE_ID="$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER}"
    RELEASE_DIR="$APP_DIR/releases/$RELEASE_ID"

    mkdir -p "$APP_DIR/releases" "$APP_DIR/shared"
    rm -rf "$RELEASE_DIR"
    mkdir -p "$RELEASE_DIR"

    rsync -a --delete --exclude ".git" --exclude "node_modules" ./ "$RELEASE_DIR/"

    echo "${{ secrets.PROD_ENV_FILE }}" > "$APP_DIR/shared/.env"
    ln -sfn "$APP_DIR/shared/.env" "$RELEASE_DIR/.env"

    cd "$RELEASE_DIR"
    npm ci --omit=dev

    if [ -L "$APP_DIR/current" ]; then
      PREV_TARGET="$(readlink -f "$APP_DIR/current")" || true
      ln -sfn "$PREV_TARGET" "$APP_DIR/previous" || true
    fi

    ln -sfn "$RELEASE_DIR" "$APP_DIR/current"

    if pm2 describe BackendApi >/dev/null 2>&1; then
      pm2 reload BackendApi || pm2 restart BackendApi
    else
      pm2 start "$APP_DIR/current/server.js" --name BackendApi
    fi

    pm2 save